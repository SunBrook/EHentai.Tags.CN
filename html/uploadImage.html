<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>上传图片示例</title>
</head>
<style>
    #div_ee8413b2 {
        width: 1190px;
        height: 609px;
        border: 2px solid red;
    }

    #div_bg::before {
        /* background: url('./wallper.png') 0 / cover; */
        background-size: 100%;
        opacity: 0.5;
    }

    #div_bg {
        z-index: -9999;
        overflow: hidden;
        position: absolute;
        width: 1190px;
        height: 609px;
    }

    #div_bg::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        filter: blur(2px);

    }
</style>
<script type="text/javascript">
    window.onload = function () {
        function changeImageIsBase64(image) {
            let that = this;
            let imageFile = image.file;
            let isJpg = false;
            // 判断图片类型
            if (imageFile.type == 'image/jpeg' || imageFile.type == 'image/png' || imageFile.type == 'image/jpg') {
                isJpg = true
            }
            console.log(imageFile.type)

            // 判断图片大小
            const isLt2M = imageFile.size / 1024 / 1024 < 0.1
            if (!isJpg) {
                that.$notify.error('转码只能是jpg/png/jepg格式')
            }
            if (!isLt2M) {
                that.$notify.error('上传图片大小不能超过100k')
            }

            // 创建一个HTML5的FileReader对象
            let reader = new FileReader()
            // 创建一个img对象
            let img = new Image()
            // let filename = file.filename
            if (imageFile) {
                reader.readAsDataURL(imageFile)
            }
            if (isJpg && isLt2M) {
                reader.onload = (e) => {
                    // let base64Str = reader.result.split[','][1]
                    img.src = e.target.result
                    // base64地址图片加载完毕后执行
                    img.onload = function () {
                        // 缩放图片需要canvas（也可以在DOM中直接定义canvas标签，这样就能把压缩完的图片不转base64也能直接显示出来）
                        let canvas = document.createElement('canvas')
                        let context = canvas.getContext('2d')
                        // 图片原始尺寸
                        let originWidth = this.width
                        let originHeight = this.height
                        // 最大尺寸限制，可通过设置宽高来实现图片压缩程度
                        let maxWidth = 300
                        let maxHeight = 300
                        // 目标尺寸
                        let targetWidth = originWidth,
                            targetHeight = originHeight
                        // 图片尺寸超过最大尺寸限制
                        if (originWidth > maxWidth || originHeight > maxHeight) {
                            if (originWidth / originHeight > maxWidth / maxHeight) {
                                // 更改宽度，按照宽度限定尺寸
                                targetWidth = maxWidth
                                targetHeight = Math.round(maxWidth * (originHeight / originWidth))
                            } else {
                                targetHeight = maxHeight
                                targetWidth = Math.round(maxHeight * (originWidth / originHeight))
                            }
                        }
                        // 对图片进行缩放
                        canvas.width = targetWidth
                        canvas.height = targetHeight
                        // 清除画布
                        context.clearRect(0, 0, targetWidth, targetHeight)
                        /** 图片压缩
                         * 第一个参数是创建的img对象
                         * 第二三个参数是左上角坐标
                         * 后两个参数是画布区域宽高
                         */
                        context.drawImage(img, 0, 0, targetWidth, targetHeight)
                        /** 压缩后的base64文件
                         * 第一个参数可以为image/jpeg或image/webp类型的图片
                         * 第二个参数设置图片质量取值0-1，超出则以默认值0.92替代
                         */
                        let newUrl = canvas.toDataURL('image/jpeg', 0.02)
                        // if (isCompression) { // 返回压缩后的base64
                        //     callback(newUrl)
                        // } else { // 返回不压缩的base64
                        //     callback(e.target.result)
                        // }
                        that.icon = newUrl;
                    }
                }
            }
        }

        var uploadBtn = document.getElementById("upload");
        var favoriteUploadFiles = document.getElementById("favorite_upload_files");
        uploadBtn.onclick = function () {
            favoriteUploadFiles.click();
        }

        favoriteUploadFiles.onchange = function () {
            var resultFile = favoriteUploadFiles.files[0];
            if (resultFile) {
                var reader = new FileReader();
                reader.readAsDataURL(resultFile);

                reader.onload = function (e) {
                    var fileContent = e.target.result;
                    console.log(fileContent);

                    // 尝试设置背景图片
                    var wrapper = document.getElementById("div_bg");
                    //wrapper.style.backgroundImage = `url(data:image/png;base64,"${fileContent}" )`;

                    let arr = fileContent.split(",");
                    //wrapper.style.background = 'url(' + 'data:image/png;base64,' + arr[1] + ') 0 / cover fixed';
                    var bg = 'url(' + 'data:image/png;base64,' + arr[1] + ') 0 / cover';
                    
                    // wrapper.style.backgroundSize = '100%';
                    // wrapper.style.opacity = "0.5";

                    var style = document.createElement('style');
                    style.innerHTML = `#div_bg::before{background:${bg}}`;
                    document.head.appendChild(style);

                    // 上传置空
                    favoriteUploadFiles.value = "";
                }
            }
        }
    }


</script>

<body style="margin: 0;padding: 0;background-color: #4F535B;">
    <div id="div_ee8413b2">
        <div id="div_bg"></div>
        <p style="color:white;position: relative;">123456</p>
        <input type="file" id="favorite_upload_files" style="display: none;" accept="image/gif,image/jpeg,image/jpg,image/png,image/svg" />
        <input type="button" style="position:relative; " value="上传图片" id="upload" />

    </div>
</body>

</html>